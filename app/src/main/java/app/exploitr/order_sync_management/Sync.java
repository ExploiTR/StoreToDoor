package app.exploitr.order_sync_management;

import android.content.Context;
import android.widget.Toast;

import com.google.firebase.crashlytics.FirebaseCrashlytics;
import com.squareup.okhttp.Callback;
import com.squareup.okhttp.MediaType;
import com.squareup.okhttp.OkHttpClient;
import com.squareup.okhttp.Request;
import com.squareup.okhttp.RequestBody;
import com.squareup.okhttp.Response;

import org.json.JSONException;
import org.json.JSONObject;

import java.io.IOException;

import app.exploitr.storetodoor.functions.majors.LocalDatabase;
import okio.Buffer;

public class Sync {
	public static void sendMessage(Context context, String recipient_token, final String title, final String body, final String icon, final String message) {
		try {
			JSONObject root = new JSONObject();

			//notification <--
			JSONObject notification = new JSONObject();
			notification.put("body", body);
			notification.put("title", title);
			notification.put("icon", icon);

			//msg <--
			JSONObject data = new JSONObject();
			data.put("message", message);
			root.put("notification", notification);

			//parent <---
			root.put("data", data);
			root.put("to", recipient_token);

			postToFCM(root.toString(), context);
		} catch (JSONException e) {
			e.printStackTrace();
			Toast.makeText(context, "Message Failed, Unknown error occurred.", Toast.LENGTH_LONG).show();
		}
	}

	private static void postToFCM(String bodyString, Context context) {
		String FCM_MESSAGE_URL = "https://fcm.googleapis.com/fcm/send";
		MediaType JSON = MediaType.parse("application/json; charset=utf-8");

		RequestBody body = RequestBody.create(JSON, bodyString);
		Request request = new Request.Builder()
				.url(FCM_MESSAGE_URL)
				.post(body)
				.addHeader("Authorization", "key=" + LocalDatabase.getInstance(context).getServerKey())
				.build();

		new OkHttpClient()
				.newCall(request)
				.enqueue(new Callback() {
					@Override
					public void onFailure(Request request, IOException e) {
						e.printStackTrace();
						FirebaseCrashlytics.getInstance().recordException(e);
					}

					@Override
					public void onResponse(Response response) {
						try {
							System.out.println(response.body().string());
						} catch (IOException e) {
							e.printStackTrace();
						}
						System.out.println(response.code());
					}
				});
	}
}
